CREATE OR REPLACE VIEW vw_topic_history AS
SELECT
    sr.study_record_id AS id,
    COALESCE(rc.topic_id, sci.topic_id) AS topic_id,

    t.topic_order        AS topic_order,
    t.description        AS topic_description,
    t.incidence_score    AS topic_incidence_score,
    t.knowledge_score    AS topic_knowledge_score,
    s.description        AS subject_description,
    t.annotation         AS topic_annotation,

    sr.started_at        AS record_started_at,
    sr.questions_solved,
    sr.questions_incorrected,
    sr.questions_percent,
    sr.annotation        AS record_annotation,
    sr.study_type,

    SUM(sr.duration_minutes) OVER (PARTITION BY COALESCE(rc.topic_id, sci.topic_id))
        AS topic_total_duration_minutes,

    CASE
        WHEN SUM(sr.questions_solved) OVER (PARTITION BY COALESCE(rc.topic_id, sci.topic_id)) = 0 THEN 0
        ELSE
            SUM(sr.questions_percent * sr.questions_solved)
                OVER (PARTITION BY COALESCE(rc.topic_id, sci.topic_id))
            /
            SUM(sr.questions_solved)
                OVER (PARTITION BY COALESCE(rc.topic_id, sci.topic_id))
    END AS topic_avg_score

FROM study_record sr

LEFT JOIN review_control rc
       ON rc.review_control_id = sr.review_control_id

LEFT JOIN study_cycle_item sci
       ON sci.study_cycle_item_id = sr.study_cycle_item_id

JOIN topic t
     ON t.topic_id = COALESCE(rc.topic_id, sci.topic_id)

JOIN subject s
     ON s.subject_id = t.subject_id

WHERE COALESCE(rc.topic_id, sci.topic_id) IS NOT NULL
ORDER BY sr.started_at DESC, sr.study_record_id DESC;