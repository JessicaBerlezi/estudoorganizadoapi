CREATE OR REPLACE VIEW vw_topic_study_history AS
SELECT
    CONCAT(
       sc.study_cycle_id, '-',
       t.topic_id, '-',
       IFNULL(sr.study_record_id, 0)
    ) AS id,

    sc.study_cycle_id    AS cycle_id,
    sc.description       AS cycle_description,
    sc.annotation        AS cycle_annotation,
    sc.started_datetime  AS cycle_started_at,

    t.topic_id           AS topic_id,
    t.description        AS topic_description,
    t.incidence_score    AS topic_incidence_score,
    t.knowledge_score    AS topic_knowledge_score,
    t.topic_order        AS topic_order,
    t.annotation         AS topic_annotation,

    s.description        AS subject_description,

     sr.study_record_id   AS record_id,
    sr.started_at        AS record_started_at,
    sr.duration_minutes  AS record_duration_minutes,
    sr.questions_solved,
    sr.questions_incorrected,
    sr.questions_percent,
    sr.annotation        AS record_annotation,
    sr.study_type,

    SUM(sr.duration_minutes) OVER (PARTITION BY t.topic_id)
        AS topic_total_duration_minutes,

    CASE
        WHEN SUM(sr.questions_solved) OVER (PARTITION BY t.topic_id) = 0 THEN 0
        ELSE
            SUM(sr.questions_percent * sr.questions_solved) OVER (PARTITION BY t.topic_id)
            /
            SUM(sr.questions_solved) OVER (PARTITION BY t.topic_id)
    END AS topic_avg_score

FROM study_cycle_item i
JOIN study_cycle sc  ON sc.study_cycle_id = i.study_cycle_id
JOIN topic t         ON t.topic_id = i.topic_id
JOIN subject s       ON t.subject_id = s.subject_id
LEFT JOIN study_record sr ON sr.study_cycle_item_id = i.study_cycle_item_id

WHERE sc.is_active = TRUE
  AND t.is_active = TRUE
  AND i.done_at IS NULL;